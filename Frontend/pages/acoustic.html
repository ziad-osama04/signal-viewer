<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acoustic Signal Analysis</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #0a0e1a;
            color: #e0e6f0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ===== Top Navigation Tabs ===== */
        .tab-bar {
            display: flex;
            background: linear-gradient(135deg, #0d1327 0%, #151d3a 100%);
            border-bottom: 1px solid rgba(99, 140, 255, 0.15);
            padding: 0 20px;
            flex-shrink: 0;
        }

        .tab-bar a {
            text-decoration: none;
            color: #7a8bb5;
            padding: 16px 28px;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.5px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-bar a:hover {
            color: #a8bcf0;
        }

        .tab-bar a.active {
            color: #638cff;
            border-bottom-color: #638cff;
        }

        .tab-bar .logo {
            font-size: 16px;
            font-weight: 700;
            color: #638cff;
            padding: 16px 20px 16px 0;
            border-right: 1px solid rgba(99, 140, 255, 0.15);
            margin-right: 10px;
            cursor: default;
        }

        /* ===== Content Layout ===== */
        .content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
        }

        /* Sidebar + Main */
        .sidebar {
            width: 320px;
            background: linear-gradient(180deg, #0d1327, #111a33);
            border-right: 1px solid rgba(99, 140, 255, 0.1);
            padding: 24px 20px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .main-panel {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: #0a0e1a;
        }

        /* Cards */
        .card {
            background: linear-gradient(135deg, rgba(20, 28, 58, 0.8), rgba(15, 22, 48, 0.9));
            border: 1px solid rgba(99, 140, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            backdrop-filter: blur(10px);
            transition: border-color 0.3s;
        }

        .card:hover {
            border-color: rgba(99, 140, 255, 0.25);
        }

        .card h3 {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #638cff;
            margin-bottom: 14px;
        }

        /* Inputs */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #7a8bb5;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .form-group input[type="range"] {
            width: 100%;
            accent-color: #638cff;
            margin-bottom: 4px;
        }

        .range-val {
            font-size: 22px;
            font-weight: 700;
            color: #fff;
        }

        .range-unit {
            font-size: 12px;
            color: #7a8bb5;
            margin-left: 4px;
        }

        select,
        input[type="file"] {
            width: 100%;
            padding: 10px 14px;
            background: rgba(10, 14, 26, 0.8);
            border: 1px solid rgba(99, 140, 255, 0.2);
            border-radius: 8px;
            color: #e0e6f0;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            outline: none;
            transition: border-color 0.3s;
        }

        select:focus,
        input[type="file"]:focus {
            border-color: #638cff;
        }

        select option {
            background: #0d1327;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #638cff, #4a6cf7);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 140, 255, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #7a9fff, #5b7df8);
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(99, 140, 255, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #34d399, #10b981);
            color: white;
            box-shadow: 0 4px 15px rgba(52, 211, 153, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(52, 211, 153, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: #1a1a2e;
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Result cards */
        .result-card {
            background: linear-gradient(135deg, rgba(20, 28, 58, 0.8), rgba(15, 22, 48, 0.9));
            border: 1px solid rgba(99, 140, 255, 0.1);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 14px;
        }

        .result-card.highlight {
            border-color: rgba(52, 211, 153, 0.5);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(15, 22, 48, 0.9));
        }

        .result-card.danger {
            border-color: rgba(251, 191, 36, 0.5);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(99, 140, 255, 0.06);
        }

        .stat-label {
            color: #7a8bb5;
            font-size: 13px;
        }

        .stat-value {
            color: #fff;
            font-weight: 600;
            font-size: 13px;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: rgba(52, 211, 153, 0.15);
            color: #34d399;
        }

        .badge-warning {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* Chart containers */
        .chart-box {
            background: rgba(13, 19, 39, 0.5);
            border: 1px solid rgba(99, 140, 255, 0.08);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 16px;
        }

        .chart-box h4 {
            font-size: 12px;
            color: #7a8bb5;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* Grid layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        /* Spinner */
        .spinner {
            display: none;
            text-align: center;
            padding: 40px;
            color: #638cff;
        }

        .spinner.active {
            display: block;
        }

        .spinner::before {
            content: '';
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid rgba(99, 140, 255, 0.2);
            border-top-color: #638cff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Drone detection table */
        .detection-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .detection-table th {
            text-align: left;
            padding: 10px 12px;
            background: rgba(99, 140, 255, 0.08);
            color: #638cff;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .detection-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(99, 140, 255, 0.06);
            font-size: 13px;
        }

        .detection-table tr.drone-row {
            background: rgba(52, 211, 153, 0.06);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #4a5580;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state h3 {
            color: #7a8bb5;
            margin-bottom: 8px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(99, 140, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 140, 255, 0.4);
        }
    </style>
</head>

<body>

    <!-- ===== Tab Bar ===== -->
    <div class="tab-bar">
        <span class="logo">üîä Acoustic</span>
        <a class="active" onclick="switchTab('simulator')">Doppler Simulator</a>
        <a onclick="switchTab('analysis')">Doppler Analysis</a>
        <a onclick="switchTab('drone')">Drone Detection</a>
    </div>

    <div class="content-area">

        <!-- ========================================== -->
        <!-- TAB 1: DOPPLER SIMULATOR                   -->
        <!-- ========================================== -->
        <div id="tab-simulator" class="tab-content active">
            <div class="sidebar">
                <div class="card">
                    <h3>‚öô Parameters</h3>

                    <div class="form-group">
                        <label>Horn Frequency</label>
                        <input type="range" id="simFreq" min="100" max="2000" value="440" step="10"
                            oninput="document.getElementById('simFreqVal').textContent = this.value">
                        <span class="range-val" id="simFreqVal">440</span>
                        <span class="range-unit">Hz</span>
                    </div>

                    <div class="form-group">
                        <label>Vehicle Speed</label>
                        <input type="range" id="simVel" min="10" max="200" value="80" step="5"
                            oninput="document.getElementById('simVelVal').textContent = this.value">
                        <span class="range-val" id="simVelVal">80</span>
                        <span class="range-unit">km/h</span>
                    </div>

                    <button class="btn btn-primary" id="btnSimulate" onclick="runSimulation()">
                        Generate Doppler Sound
                    </button>
                </div>

                <div class="card" id="simParamsCard" style="display:none;">
                    <h3>üìã Parameters</h3>
                    <div id="simParamsInfo"></div>
                </div>
            </div>

            <div class="main-panel">
                <div id="simLoading" class="spinner"></div>
                <div id="simEmpty" class="empty-state">
                    <div class="icon">üéµ</div>
                    <h3>Doppler Effect Simulator</h3>
                    <p>Adjust frequency and velocity, then click Generate to hear and visualize the Doppler effect</p>
                </div>
                <div id="simCharts" style="display:none;">
                    <div class="chart-box">
                        <h4>Waveform ‚Äî Simulated Car Pass</h4>
                        <div id="simWaveform" style="height:220px;"></div>
                    </div>
                    <div class="chart-box">
                        <h4>Observed Frequency Over Time</h4>
                        <div id="simFreqChart" style="height:220px;"></div>
                    </div>
                    <div id="simAudioContainer" style="text-align:center; margin-top:12px;"></div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- TAB 2: DOPPLER ANALYSIS                    -->
        <!-- ========================================== -->
        <div id="tab-analysis" class="tab-content">
            <div class="sidebar">
                <div class="card">
                    <h3>üìÇ Dataset</h3>
                    <div class="form-group">
                        <label>Select Doppler Recording</label>
                        <select id="dopplerSelect">
                            <option value="">Loading datasets...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="analyzeDoppler()" id="btnAnalyze">
                        Analyze Signal
                    </button>
                </div>

                <div class="card">
                    <h3>üìÅ Upload Custom</h3>
                    <div class="form-group">
                        <input type="file" id="dopplerFileInput" accept=".wav,.mp3">
                    </div>
                    <button class="btn btn-success" onclick="uploadDoppler()">
                        Upload & Analyze
                    </button>
                </div>

                <div class="card" id="dopplerResultCard" style="display:none;">
                    <h3>üìä Doppler Results</h3>
                    <div id="dopplerResults"></div>
                </div>

                <div class="card" id="dopplerStatsCard" style="display:none;">
                    <h3>üìà Signal Statistics</h3>
                    <div id="dopplerStats"></div>
                </div>
            </div>

            <div class="main-panel">
                <div id="analysisLoading" class="spinner"></div>
                <div id="analysisEmpty" class="empty-state">
                    <div class="icon">üì°</div>
                    <h3>Doppler Signal Analysis</h3>
                    <p>Select a recording from the dataset or upload your own to estimate vehicle speed</p>
                </div>
                <div id="analysisCharts" style="display:none;">
                    <div class="chart-box">
                        <h4>Waveform</h4>
                        <div id="dopplerWaveform" style="height:200px;"></div>
                    </div>
                    <div class="grid-2">
                        <div class="chart-box">
                            <h4>FFT ‚Äî Frequency Spectrum</h4>
                            <div id="dopplerFFT" style="height:220px;"></div>
                        </div>
                        <div class="chart-box">
                            <h4>Frequency Over Time (Doppler Curve)</h4>
                            <div id="dopplerFreqCurve" style="height:220px;"></div>
                        </div>
                    </div>
                    <div class="chart-box">
                        <h4>Spectrogram</h4>
                        <div id="dopplerSpectrogram" style="height:260px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- TAB 3: DRONE DETECTION                     -->
        <!-- ========================================== -->
        <div id="tab-drone" class="tab-content">
            <div class="sidebar">
                <div class="card">
                    <h3>üõ∏ Drone Detection</h3>
                    <p style="font-size:12px; color:#7a8bb5; margin-bottom:14px;">
                        Upload any audio file (WAV or MP3) to classify it as a drone or other sound using spectral
                        feature analysis.
                    </p>
                    <div class="form-group">
                        <label>Select Audio File</label>
                        <input type="file" id="droneFileInput" accept=".wav,.mp3,.ogg,.flac">
                    </div>
                    <button class="btn btn-warning" onclick="uploadDrone()" id="btnDetect">
                        üîç Upload &amp; Classify
                    </button>
                </div>

                <div class="card" id="droneResultCard" style="display:none;">
                    <h3>üìã Classification Result</h3>
                    <div id="droneResultInfo"></div>
                </div>

                <div class="card" id="droneStatsCard" style="display:none;">
                    <h3>üìä Signal Statistics</h3>
                    <div id="droneStats"></div>
                </div>
            </div>

            <div class="main-panel">
                <div id="droneLoading" class="spinner"></div>
                <div id="droneEmpty" class="empty-state">
                    <div class="icon">üõ∏</div>
                    <h3>Drone Sound Detection</h3>
                    <p>Upload an audio file to classify it as a drone, bird, engine, or other sound</p>
                </div>
                <div id="droneCharts" style="display:none;">
                    <div class="chart-box">
                        <h4>Waveform</h4>
                        <div id="droneWaveform" style="height:200px;"></div>
                    </div>
                    <div class="grid-2">
                        <div class="chart-box">
                            <h4>FFT ‚Äî Frequency Spectrum</h4>
                            <div id="droneFFTChart" style="height:220px;"></div>
                        </div>
                        <div class="chart-box">
                            <h4>Spectral Features</h4>
                            <div id="droneFeaturesChart" style="height:220px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ===== JavaScript ===== -->
    <script>
        // Plotly dark theme defaults
        const plotLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(13,19,39,0.5)',
            font: { color: '#7a8bb5', family: 'Inter', size: 11 },
            margin: { t: 10, b: 40, l: 55, r: 20 },
            xaxis: { gridcolor: 'rgba(99,140,255,0.06)', zerolinecolor: 'rgba(99,140,255,0.1)' },
            yaxis: { gridcolor: 'rgba(99,140,255,0.06)', zerolinecolor: 'rgba(99,140,255,0.1)' },
        };
        const plotConfig = { displayModeBar: false, responsive: true };

        // ===== TAB SWITCHING =====
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-bar a').forEach(a => a.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            event.target.classList.add('active');

            // Load datasets on first visit
            if (tab === 'analysis' && !window._dopplerLoaded) loadDopplerDatasets();
        }

        // ========================================================
        // TAB 1: DOPPLER SIMULATOR
        // ========================================================
        async function runSimulation() {
            const freq = parseInt(document.getElementById('simFreq').value);
            const vel = parseInt(document.getElementById('simVel').value);
            const btn = document.getElementById('btnSimulate');

            btn.disabled = true;
            btn.textContent = 'Generating...';
            showLoading('sim');

            try {
                const res = await fetch('/api/acoustic/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frequency: freq, velocity: vel }),
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error);

                // Show charts
                document.getElementById('simEmpty').style.display = 'none';
                document.getElementById('simCharts').style.display = 'block';

                // Waveform
                Plotly.newPlot('simWaveform', [{
                    x: data.time,
                    y: data.waveform,
                    mode: 'lines',
                    line: { color: '#638cff', width: 1.2 },
                    name: 'Amplitude',
                }], {
                    ...plotLayout,
                    xaxis: { ...plotLayout.xaxis, title: 'Time (s)' },
                    yaxis: { ...plotLayout.yaxis, title: 'Amplitude' },
                }, plotConfig);

                // Frequency over time
                Plotly.newPlot('simFreqChart', [{
                    x: data.time_freq,
                    y: data.freq_over_time,
                    mode: 'lines',
                    line: { color: '#34d399', width: 2 },
                    name: 'Observed Frequency',
                }, {
                    x: [data.time_freq[0], data.time_freq[data.time_freq.length - 1]],
                    y: [freq, freq],
                    mode: 'lines',
                    line: { color: '#fbbf24', width: 1.5, dash: 'dash' },
                    name: 'Source Frequency',
                }], {
                    ...plotLayout,
                    showlegend: true,
                    legend: { x: 0.7, y: 0.95, font: { size: 10 } },
                    xaxis: { ...plotLayout.xaxis, title: 'Time (s)' },
                    yaxis: { ...plotLayout.yaxis, title: 'Frequency (Hz)' },
                }, plotConfig);

                // Generate audio for playback
                generateAudio(data.signal, data.sr);

                // Show params card
                document.getElementById('simParamsCard').style.display = 'block';
                document.getElementById('simParamsInfo').innerHTML = `
                    <div class="stat-row"><span class="stat-label">Source Freq</span><span class="stat-value">${freq} Hz</span></div>
                    <div class="stat-row"><span class="stat-label">Vehicle Speed</span><span class="stat-value">${vel} km/h</span></div>
                    <div class="stat-row"><span class="stat-label">Speed (m/s)</span><span class="stat-value">${data.params.v_car_ms}</span></div>
                    <div class="stat-row"><span class="stat-label">Duration</span><span class="stat-value">${data.params.duration}s</span></div>
                    <div class="stat-row"><span class="stat-label">Sample Rate</span><span class="stat-value">${data.params.sr} Hz</span></div>
                `;

            } catch (err) {
                alert('Simulation failed: ' + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Generate Doppler Sound';
                hideLoading('sim');
            }
        }

        function generateAudio(signal, sr) {
            // Create WAV blob from signal array for browser playback
            const container = document.getElementById('simAudioContainer');
            const numSamples = signal.length;
            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);

            // WAV header
            const writeStr = (offset, str) => { for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i)); };
            writeStr(0, 'RIFF');
            view.setUint32(4, 36 + numSamples * 2, true);
            writeStr(8, 'WAVE');
            writeStr(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sr, true);
            view.setUint32(28, sr * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeStr(36, 'data');
            view.setUint32(40, numSamples * 2, true);

            for (let i = 0; i < numSamples; i++) {
                const s = Math.max(-1, Math.min(1, signal[i]));
                view.setInt16(44 + i * 2, s * 0x7FFF, true);
            }

            const blob = new Blob([buffer], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            container.innerHTML = `
                <audio controls style="width:100%; margin-top:8px; filter: hue-rotate(190deg);">
                    <source src="${url}" type="audio/wav">
                </audio>
            `;
        }

        // ========================================================
        // TAB 2: DOPPLER ANALYSIS
        // ========================================================
        async function loadDopplerDatasets() {
            try {
                const res = await fetch('/api/acoustic/doppler/datasets');
                const data = await res.json();
                const select = document.getElementById('dopplerSelect');
                select.innerHTML = '<option value="">-- Select a file --</option>';

                if (data.files) {
                    data.files.forEach(f => {
                        const speed = f.actual_speed_kmh ? ` (${f.actual_speed_kmh} km/h)` : '';
                        select.innerHTML += `<option value="${f.filename}">${f.filename}${speed}</option>`;
                    });
                }
                window._dopplerLoaded = true;
            } catch (err) {
                console.error('Failed to load datasets:', err);
            }
        }

        async function analyzeDoppler() {
            const filename = document.getElementById('dopplerSelect').value;
            if (!filename) return alert('Please select a file');

            const btn = document.getElementById('btnAnalyze');
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            showLoading('analysis');

            try {
                const res = await fetch(`/api/acoustic/doppler/analyze/${encodeURIComponent(filename)}`);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                renderDopplerResults(data);
            } catch (err) {
                alert('Analysis failed: ' + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Analyze Signal';
                hideLoading('analysis');
            }
        }

        async function uploadDoppler() {
            const file = document.getElementById('dopplerFileInput').files[0];
            if (!file) return alert('Please select a file');

            showLoading('analysis');
            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/acoustic/doppler/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                renderDopplerResults(data);
            } catch (err) {
                alert('Upload failed: ' + err.message);
            } finally {
                hideLoading('analysis');
            }
        }

        function renderDopplerResults(data) {
            document.getElementById('analysisEmpty').style.display = 'none';
            document.getElementById('analysisCharts').style.display = 'block';

            const d = data.doppler;
            const actualSpeed = data.actual_speed_kmh;

            // ===== Waveform =====
            Plotly.newPlot('dopplerWaveform', [{
                x: data.waveform.time,
                y: data.waveform.amplitude,
                mode: 'lines',
                line: { color: '#638cff', width: 1 },
            }], {
                ...plotLayout,
                xaxis: { ...plotLayout.xaxis, title: 'Time (s)' },
                yaxis: { ...plotLayout.yaxis, title: 'Amplitude' },
            }, plotConfig);

            // ===== FFT =====
            Plotly.newPlot('dopplerFFT', [{
                x: data.fft.frequencies,
                y: data.fft.magnitudes,
                mode: 'lines',
                line: { color: '#a78bfa', width: 1.2 },
                fill: 'tozeroy',
                fillcolor: 'rgba(167,139,250,0.1)',
            }], {
                ...plotLayout,
                xaxis: { ...plotLayout.xaxis, title: 'Frequency (Hz)', range: [0, 3000] },
                yaxis: { ...plotLayout.yaxis, title: 'Magnitude' },
            }, plotConfig);

            // ===== Frequency Over Time (Doppler curve) =====
            if (d && d.freq_over_time && d.freq_over_time.length > 0) {
                const traces = [{
                    x: d.freq_time_axis,
                    y: d.freq_over_time,
                    mode: 'lines',
                    line: { color: '#34d399', width: 2 },
                    name: 'Dominant Freq',
                }];

                if (d.approach_freq_hz) {
                    traces.push({
                        x: [d.freq_time_axis[0], d.freq_time_axis[d.freq_time_axis.length - 1]],
                        y: [d.approach_freq_hz, d.approach_freq_hz],
                        mode: 'lines',
                        line: { color: '#fbbf24', width: 1.5, dash: 'dash' },
                        name: `Approach (${d.approach_freq_hz} Hz)`,
                    });
                    traces.push({
                        x: [d.freq_time_axis[0], d.freq_time_axis[d.freq_time_axis.length - 1]],
                        y: [d.recede_freq_hz, d.recede_freq_hz],
                        mode: 'lines',
                        line: { color: '#ef4444', width: 1.5, dash: 'dash' },
                        name: `Recede (${d.recede_freq_hz} Hz)`,
                    });
                }

                Plotly.newPlot('dopplerFreqCurve', traces, {
                    ...plotLayout,
                    showlegend: true,
                    legend: { x: 0.6, y: 0.95, font: { size: 10 } },
                    xaxis: { ...plotLayout.xaxis, title: 'Time (s)' },
                    yaxis: { ...plotLayout.yaxis, title: 'Frequency (Hz)' },
                }, plotConfig);
            }

            // ===== Spectrogram =====
            if (data.spectrogram) {
                Plotly.newPlot('dopplerSpectrogram', [{
                    x: data.spectrogram.times,
                    y: data.spectrogram.frequencies,
                    z: data.spectrogram.power,
                    type: 'heatmap',
                    colorscale: [
                        [0, '#0a0e1a'], [0.2, '#1a1145'], [0.4, '#3b1f8e'],
                        [0.6, '#638cff'], [0.8, '#34d399'], [1, '#fbbf24']
                    ],
                    showscale: true,
                    colorbar: { title: 'dB', titlefont: { size: 10 }, tickfont: { size: 9 } },
                }], {
                    ...plotLayout,
                    xaxis: { ...plotLayout.xaxis, title: 'Time (s)' },
                    yaxis: { ...plotLayout.yaxis, title: 'Frequency (Hz)', range: [0, 3000] },
                }, plotConfig);
            }

            // ===== Doppler result card =====
            const card = document.getElementById('dopplerResultCard');
            card.style.display = 'block';

            let html = `
                <div class="stat-row"><span class="stat-label">Estimated Speed</span><span class="stat-value" style="color:#34d399;">${d.estimated_velocity_kmh} km/h</span></div>
                <div class="stat-row"><span class="stat-label">Estimated Freq</span><span class="stat-value">${d.estimated_frequency_hz} Hz</span></div>
                <div class="stat-row"><span class="stat-label">Approach Freq</span><span class="stat-value">${d.approach_freq_hz} Hz</span></div>
                <div class="stat-row"><span class="stat-label">Recede Freq</span><span class="stat-value">${d.recede_freq_hz} Hz</span></div>
            `;
            if (actualSpeed) {
                const error = Math.abs(d.estimated_velocity_kmh - actualSpeed);
                const errorPct = ((error / actualSpeed) * 100).toFixed(1);
                html += `
                    <div class="stat-row" style="margin-top:10px;border-top:1px solid rgba(99,140,255,0.15);padding-top:10px;">
                        <span class="stat-label">Actual Speed</span><span class="stat-value" style="color:#fbbf24;">${actualSpeed} km/h</span>
                    </div>
                    <div class="stat-row"><span class="stat-label">Error</span><span class="stat-value">${error.toFixed(1)} km/h (${errorPct}%)</span></div>
                `;
            }
            html += `<div class="stat-row"><span class="stat-label">Algorithm</span><span class="stat-value" style="font-size:10px;">${d.algorithm}</span></div>`;
            document.getElementById('dopplerResults').innerHTML = html;

            // ===== Stats card =====
            if (data.statistics) {
                const s = data.statistics;
                document.getElementById('dopplerStatsCard').style.display = 'block';
                document.getElementById('dopplerStats').innerHTML = `
                    <div class="stat-row"><span class="stat-label">Duration</span><span class="stat-value">${s.duration_s}s</span></div>
                    <div class="stat-row"><span class="stat-label">Sample Rate</span><span class="stat-value">${s.sample_rate} Hz</span></div>
                    <div class="stat-row"><span class="stat-label">RMS</span><span class="stat-value">${s.rms}</span></div>
                    <div class="stat-row"><span class="stat-label">SNR</span><span class="stat-value">${s.snr_db} dB</span></div>
                    <div class="stat-row"><span class="stat-label">Peak-to-Peak</span><span class="stat-value">${s.peak_to_peak}</span></div>
                `;
            }
        }

        // ========================================================
        // TAB 3: DRONE DETECTION (Upload-based)
        // ========================================================
        async function uploadDrone() {
            const file = document.getElementById('droneFileInput').files[0];
            if (!file) return alert('Please select an audio file');

            const btn = document.getElementById('btnDetect');
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            showLoading('drone');

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch('/api/acoustic/drone/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                renderDroneUploadResult(data);
            } catch (err) {
                alert('Classification failed: ' + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = '\ud83d\udd0d Upload & Classify';
                hideLoading('drone');
            }
        }

        function renderDroneUploadResult(data) {
            document.getElementById('droneEmpty').style.display = 'none';
            document.getElementById('droneCharts').style.display = 'block';

            const c = data.classification;
            const f = data.features || {};
            const isDrone = c.label === 'Drone Detected' || c.label === 'Possible Drone';
            const badgeClass = c.confidence >= 0.6 ? 'badge-success' : c.confidence >= 0.4 ? 'badge-warning' : 'badge-danger';

            // Classification result card
            const resultCard = document.getElementById('droneResultCard');
            resultCard.style.display = 'block';
            document.getElementById('droneResultInfo').innerHTML = `
                <div class="stat-row"><span class="stat-label">File</span><span class="stat-value">${data.filename}</span></div>
                <div class="stat-row"><span class="stat-label">Result</span><span class="badge ${badgeClass}">${c.label}</span></div>
                <div class="stat-row"><span class="stat-label">Confidence</span><span class="stat-value" style="color:${isDrone ? '#34d399' : '#ef4444'};">${(c.confidence * 100).toFixed(0)}%</span></div>
                <div class="stat-row"><span class="stat-label">Score</span><span class="stat-value">${c.score}</span></div>
                ${c.reasons ? '<div style="margin-top:8px;font-size:11px;color:#7a8bb5;">' + c.reasons.map(r => '‚Ä¢ ' + r).join('<br>') + '</div>' : ''}
            `;

            // Stats card
            if (data.statistics) {
                const s = data.statistics;
                document.getElementById('droneStatsCard').style.display = 'block';
                document.getElementById('droneStats').innerHTML = `
                    <div class="stat-row"><span class="stat-label">Duration</span><span class="stat-value">${s.duration_s}s</span></div>
                    <div class="stat-row"><span class="stat-label">Sample Rate</span><span class="stat-value">${s.sample_rate} Hz</span></div>
                    <div class="stat-row"><span class="stat-label">RMS</span><span class="stat-value">${s.rms}</span></div>
                    <div class="stat-row"><span class="stat-label">SNR</span><span class="stat-value">${s.snr_db} dB</span></div>
                `;
            }

            // Waveform
            if (data.waveform) {
                Plotly.newPlot('droneWaveform', [{
                    x: data.waveform.time,
                    y: data.waveform.amplitude,
                    mode: 'lines',
                    line: { color: isDrone ? '#34d399' : '#638cff', width: 1 },
                }], {
                    ...plotLayout,
                    xaxis: { ...plotLayout.xaxis, title: 'Time (s)' },
                    yaxis: { ...plotLayout.yaxis, title: 'Amplitude' },
                }, plotConfig);
            }

            // FFT
            if (data.fft) {
                Plotly.newPlot('droneFFTChart', [{
                    x: data.fft.frequencies,
                    y: data.fft.magnitudes,
                    mode: 'lines',
                    line: { color: isDrone ? '#34d399' : '#a78bfa', width: 1.2 },
                    fill: 'tozeroy',
                    fillcolor: isDrone ? 'rgba(52,211,153,0.08)' : 'rgba(167,139,250,0.08)',
                }], {
                    ...plotLayout,
                    xaxis: { ...plotLayout.xaxis, title: 'Frequency (Hz)', range: [0, 5000] },
                    yaxis: { ...plotLayout.yaxis, title: 'Magnitude' },
                }, plotConfig);
            }

            // Spectral features bar chart
            if (f.spectral_centroid !== undefined) {
                const featureLabels = ['Centroid', 'Bandwidth', 'Rolloff', 'Dom. Freq', 'ZCR \u00d71000'];
                const featureValues = [
                    f.spectral_centroid || 0,
                    f.spectral_bandwidth || 0,
                    f.spectral_rolloff || 0,
                    f.dominant_freq || 0,
                    (f.zero_crossing_rate || 0) * 1000,
                ];
                const featureColors = featureValues.map(() => isDrone ? '#34d399' : '#638cff');

                Plotly.newPlot('droneFeaturesChart', [{
                    x: featureLabels,
                    y: featureValues,
                    type: 'bar',
                    marker: { color: featureColors, opacity: 0.85 },
                }], {
                    ...plotLayout,
                    yaxis: { ...plotLayout.yaxis, title: 'Value' },
                }, plotConfig);
            }
        }

        // ===== Helpers =====
        function showLoading(prefix) {
            document.getElementById(prefix + 'Loading').classList.add('active');
        }
        function hideLoading(prefix) {
            document.getElementById(prefix + 'Loading').classList.remove('active');
        }

        // Load Doppler datasets on page load  
        window.addEventListener('load', loadDopplerDatasets);
    </script>
</body>

</html>